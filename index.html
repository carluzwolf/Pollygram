<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pollygram Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8;
            --bg: #f8fafc; --surface: #ffffff;
            --text: #0f172a; --text-light: #64748b;
            --border: #e2e8f0; --accent: #eff6ff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; height: 100vh; }
        
        #app-container { width: 100%; max-width: 500px; background: var(--surface); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* Auth */
        .auth-screen { position: absolute; inset: 0; background: var(--surface); z-index: 2000; padding: 40px; display: flex; flex-direction: column; justify-content: center; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }

        /* Header & Nav */
        header { padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: white; }
        header h1 { font-size: 1.25rem; font-weight: 800; color: var(--primary); margin: 0; }
        
        .main-content { flex: 1; overflow-y: auto; background: var(--bg); }
        nav { height: 65px; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); background: white; }
        .nav-item { color: var(--text-light); font-size: 1.2rem; cursor: pointer; transition: 0.2s; padding: 10px; }
        .nav-item.active { color: var(--primary); }

        /* Cards e Listas */
        .post-card { background: white; margin: 10px; padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; font-weight: 600; font-size: 0.9rem; }
        .user-avatar-text { width: 35px; height: 35px; background: var(--accent); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; }
        .post-content { line-height: 1.5; color: var(--text); }

        .list-item { display: flex; align-items: center; padding: 15px 20px; background: white; border-bottom: 1px solid var(--border); cursor: pointer; }
        .list-item:hover { background: var(--accent); }
        
        /* Modais e Overlays */
        .overlay { position: absolute; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; }
        .overlay.active { transform: translateX(0); }
        .overlay-header { padding: 15px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        
        .fab { position: absolute; bottom: 85px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); cursor: pointer; }
        
        .notes-bar { display: flex; overflow-x: auto; padding: 15px; gap: 15px; background: white; border-bottom: 1px solid var(--border); }
        .note-item { min-width: 80px; text-align: center; font-size: 0.75rem; }
        .note-text-bubble { background: var(--accent); padding: 8px; border-radius: 10px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid #dbeafe; }
    </style>
</head>
<body>
<div id="app-container">
      <div id="auth-layer" class="auth-screen">
        <h1 style="text-align:center; color:var(--primary); font-size:2rem; margin-bottom:30px;">Pollygram</h1>
        <div id="login-form">
            <input type="text" id="login-user" class="auth-input" placeholder="Username">
            <input type="password" id="login-pass" class="auth-input" placeholder="Senha">
            <button class="btn-main" onclick="handleLogin()">Entrar</button>
            <p style="text-align:center; margin-top:20px; font-size:0.9rem; color:var(--text-light)" onclick="toggleAuth('signup')">Não tem conta? <span style="color:var(--primary)">Cadastre-se</span></p>
        </div>
        <div id="signup-form" class="hidden">
            <input type="text" id="signup-user" class="auth-input" placeholder="Escolha um Username">
            <input type="password" id="signup-pass" class="auth-input" placeholder="Senha">
            <button class="btn-main" onclick="handleSignup()">Criar Conta Profissional</button>
            <p style="text-align:center; margin-top:20px; font-size:0.9rem; color:var(--text-light)" onclick="toggleAuth('login')">Já tem conta? <span style="color:var(--primary)">Login</span></p>
        </div>
    </div>

    <div id="main-app" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <header>
            <h1 id="view-title">Feed</h1>
            <i class="fas fa-bell" style="color:var(--text-light)"></i>
        </header>

        <div class="main-content">
            <div id="tab-feed" class="tab-pane">
                <div class="notes-bar" id="notes-container">
                    <div class="note-item" onclick="openNoteModal()">
                        <div class="note-text-bubble" style="background:#eee;">+ Nota</div>
                        <span>Você</span>
                    </div>
                </div>
                <div id="feed-list"></div>
                <div class="fab" onclick="openPostModal()"><i class="fas fa-pen"></i></div>
            </div>

            <div id="tab-users" class="tab-pane hidden">
                <div style="padding:15px; font-size:0.8rem; color:var(--text-light); font-weight:bold;">MEMBROS DA REDE</div>
                <div id="global-users-list"></div>
            </div>

            <div id="tab-chats" class="tab-pane hidden">
                <div id="chat-inbox-list"></div>
            </div>

            <div id="tab-profile" class="tab-pane hidden">
                <div style="background:white; padding:30px 20px; text-align:center; border-bottom:1px solid var(--border);">
                    <div id="my-avatar-big" style="width:80px; height:80px; background:var(--accent); color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px; font-size:2rem; font-weight:bold;">?</div>
                    <h2 id="my-username-display" style="margin:0;"></h2>
                    <p id="my-bio-display" style="color:var(--text-light); margin:10px 0; font-size:0.9rem;"></p>
                    <button onclick="handleLogout()" style="background:none; border:1px solid #ff4444; color:#ff4444; padding:5px 15px; border-radius:5px; margin-top:10px; cursor:pointer;">Sair da Conta</button>
                </div>
                <div id="my-posts-list"></div>
            </div>
        </div>

        <nav>
            <div class="nav-item active" onclick="switchTab('feed', this)"><i class="fas fa-list-alt"></i></div>
            <div class="nav-item" onclick="switchTab('users', this)"><i class="fas fa-users"></i></div>
            <div class="nav-item" onclick="switchTab('chats', this)"><i class="fas fa-comment-dots"></i></div>
            <div class="nav-item" onclick="switchTab('profile', this)"><i class="fas fa-user-circle"></i></div>
        </nav>
    </div>
      <div id="chat-window" class="overlay">
        <div class="overlay-header">
            <i class="fas fa-arrow-left" onclick="closeOverlay('chat-window')"></i>
            <span id="chat-target-name" style="font-weight:bold;"></span>
        </div>
        <div id="chat-messages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
        <div style="padding:15px; background:white; display:flex; gap:10px; border-top:1px solid var(--border);">
            <input type="text" id="chat-input" style="flex:1; padding:12px; border-radius:25px; border:1px solid var(--border);" placeholder="Escreva...">
            <button onclick="sendChatMessage()" style="background:var(--primary); color:white; border:none; width:45px; height:45px; border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="user-profile-view" class="overlay">
        <div class="overlay-header">
            <i class="fas fa-arrow-left" onclick="closeOverlay('user-profile-view')"></i>
            <span>Perfil</span>
        </div>
        <div id="profile-view-content" style="text-align:center; padding:40px 20px;">
            <div id="view-avatar" style="width:100px; height:100px; background:var(--accent); color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; font-size:2.5rem; font-weight:bold;"></div>
            <h2 id="view-username"></h2>
            <p id="view-bio" style="color:var(--text-light);"></p>
            <button id="start-chat-btn" class="btn-main" style="max-width:200px; margin-top:20px;">Enviar Mensagem</button>
        </div>
    </div>

    <div id="post-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Novo Post em Texto</h3>
            <textarea id="post-text" class="auth-input" style="height:120px; resize:none;" placeholder="No que você está pensando?"></textarea>
            <button class="btn-main" onclick="submitPost()">Publicar</button>
            <button onclick="closeModal('post-modal')" style="width:100%; margin-top:10px; border:none; background:none;">Cancelar</button>
        </div>
    </div>

    <div id="note-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Sua Nota</h3>
            <input type="text" id="note-text" class="auth-input" maxlength="40" placeholder="Ex: Focado no trabalho...">
            <button class="btn-main" onclick="submitNote()">Salvar Nota</button>
            <button onclick="closeModal('note-modal')" style="width:100%; margin-top:10px; border:none; background:none;">Fechar</button>
        </div>
    </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyARAb2yqL8YxEkmALKQ6DJckMW9a06cer0",
        authDomain: "pollygram.firebaseapp.com",
        projectId: "pollygram",
        storageBucket: "pollygram.appspot.com",
        messagingSenderId: "725225787747",
        appId: "1:725225787747:web:4052e92bba8c3447188356"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let activeChatId = null;

    // --- AUTH ---
    window.toggleAuth = (v) => {
        document.getElementById('login-form').classList.toggle('hidden', v==='signup');
        document.getElementById('signup-form').classList.toggle('hidden', v==='login');
    };

    window.handleLogin = async () => {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        try { await signInWithEmailAndPassword(auth, `${u}@polly.pro`, p); } catch(e) { alert("Usuário ou senha inválidos."); }
    };

    window.handleSignup = async () => {
        const u = document.getElementById('signup-user').value.trim();
        const p = document.getElementById('signup-pass').value;
        if(u.length < 3) return alert("Username curto demais.");
        try {
            const res = await createUserWithEmailAndPassword(auth, `${u}@polly.pro`, p);
            await updateProfile(res.user, { displayName: u });
            await setDoc(doc(db, "users", res.user.uid), { uid: res.user.uid, username: u, bio: "Membro do Pollygram Pro", createdAt: Date.now() });
        } catch(e) { alert(e.message); }
    };

    window.handleLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        document.getElementById('auth-layer').classList.toggle('hidden', !!user);
        document.getElementById('main-app').classList.toggle('hidden', !user);
        if(user) initApp();
    });

    // --- NAVEGAÇÃO ---
    window.switchTab = (tab, el) => {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('view-title').innerText = tab.charAt(0).toUpperCase() + tab.slice(1);
    };

    function initApp() {
        // Carrega Perfil
        document.getElementById('my-username-display').innerText = currentUser.displayName;
        document.getElementById('my-avatar-big').innerText = currentUser.displayName[0].toUpperCase();
        
        loadFeed();
        loadNotes();
        loadAllUsers();
        loadInbox();
    }

    // --- FEED & POSTS ---
    function loadFeed() {
        onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snap) => {
            const list = document.getElementById('feed-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="user-avatar-text">${p.username[0]}</div>
                            ${p.username}
                        </div>
                        <div class="post-content">${p.text}</div>
                    </div>`;
            });
        });
    }

    window.submitPost = async () => {
        const text = document.getElementById('post-text').value;
        if(!text) return;
        await addDoc(collection(db, "posts"), { 
            uid: currentUser.uid, username: currentUser.displayName, 
            text, timestamp: Date.now() 
        });
        document.getElementById('post-text').value = "";
        closeModal('post-modal');
    };

    // --- USUÁRIOS E PERFIS ---
    async function loadAllUsers() {
        const snap = await getDocs(collection(db, "users"));
        const list = document.getElementById('global-users-list');
        list.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            if(u.uid === currentUser.uid) return;
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<div class="user-avatar-text">${u.username[0]}</div><div><strong>${u.username}</strong><br><small>${u.bio}</small></div>`;
            item.onclick = () => showUserProfile(u);
            list.appendChild(item);
        });
    }

    window.showUserProfile = (user) => {
        const overlay = document.getElementById('user-profile-view');
        document.getElementById('view-username').innerText = user.username;
        document.getElementById('view-bio').innerText = user.bio;
        document.getElementById('view-avatar').innerText = user.username[0];
        document.getElementById('start-chat-btn').onclick = () => {
            closeOverlay('user-profile-view');
            openChat(user.uid, user.username);
        };
        overlay.classList.add('active');
    };

    // --- CHAT ---
    window.openChat = (otherUid, otherName) => {
        activeChatId = [currentUser.uid, otherUid].sort().join("_");
        document.getElementById('chat-target-name').innerText = otherName;
        document.getElementById('chat-window').classList.add('active');
        
        onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("timestamp", "asc")), (snap) => {
            const cont = document.getElementById('chat-messages');
            cont.innerHTML = "";
            snap.forEach(m => {
                const msg = m.data();
                const isMine = msg.sender === currentUser.uid;
                const div = document.createElement('div');
                div.style = `padding:10px 15px; border-radius:15px; max-width:80%; ${isMine ? 'align-self:flex-end; background:var(--primary); color:white;' : 'align-self:flex-start; background:#e2e8f0;'}`;
                div.innerText = msg.text;
                cont.appendChild(div);
            });
            cont.scrollTop = cont.scrollHeight;
        });
    };

    window.sendChatMessage = async () => {
        const text = document.getElementById('chat-input').value;
        if(!text) return;
        await addDoc(collection(db, "chats", activeChatId, "messages"), { sender: currentUser.uid, text, timestamp: Date.now() });
        // Metadata para a Inbox
        await setDoc(doc(db, "inbox", activeChatId), {
            participants: activeChatId.split("_"),
            lastText: text,
            names: [currentUser.displayName, document.getElementById('chat-target-name').innerText],
            timestamp: Date.now()
        });
        document.getElementById('chat-input').value = "";
    };

    function loadInbox() {
        onSnapshot(query(collection(db, "inbox"), where("participants", "array-contains", currentUser.uid)), (snap) => {
            const list = document.getElementById('chat-inbox-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                const otherName = data.names.find(n => n !== currentUser.displayName);
                const otherUid = data.participants.find(id => id !== currentUser.uid);
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<div class="user-avatar-text">${otherName[0]}</div><div><strong>${otherName}</strong><br><small>${data.lastText}</small></div>`;
                div.onclick = () => openChat(otherUid, otherName);
                list.appendChild(div);
            });
        });
    }

    // --- NOTAS ---
    function loadNotes() {
        onSnapshot(collection(db, "notes"), (snap) => {
            const cont = document.getElementById('notes-container');
            cont.innerHTML = `<div class="note-item" onclick="openNoteModal()"><div class="note-text-bubble" style="background:#eee;">+ Nota</div><span>Você</span></div>`;
            snap.forEach(d => {
                const n = d.data();
                if(n.uid === currentUser.uid) return;
                cont.innerHTML += `<div class="note-item"><div class="note-text-bubble">${n.text}</div><span>${n.username}</span></div>`;
            });
        });
    }

    window.submitNote = async () => {
        const text = document.getElementById('note-text').value;
        if(!text) return;
        await setDoc(doc(db, "notes", currentUser.uid), { uid: currentUser.uid, username: currentUser.displayName, text, timestamp: Date.now() });
        closeModal('note-modal');
    };

    // Auxiliares UI
    window.openPostModal = () => document.getElementById('post-modal').classList.remove('hidden');
    window.openNoteModal = () => document.getElementById('note-modal').classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.closeOverlay = (id) => document.getElementById(id).classList.remove('active');

</script>
</body>
</html>

