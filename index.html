<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pollygram</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6B4EFF; --primary-grad: linear-gradient(135deg, #6B4EFF, #00C6FF);
            --bg: #F0F2F5; --white: #FFFFFF; --text-main: #1C1E21; --text-sec: #65676B;
            --border: #DBDBDB; --msg-out: #DCF8C6; --msg-in: #FFFFFF; --danger: #FF3B30;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg); display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        #app-container { width: 100%; max-width: 480px; height: 100%; background: var(--white); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; }
        .hidden { display: none !important; }
        .auth-screen { position: absolute; inset: 0; background: var(--white); z-index: 1000; padding: 40px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .logo-text { font-size: 2.5rem; font-weight: 800; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 15px; background: #FAFAFA; border: 1px solid var(--border); border-radius: 12px; }
        .auth-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        header { padding: 15px 20px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .main-content { flex: 1; overflow-y: auto; position: relative; }
        .bottom-nav { height: 60px; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; background: white; }
        .nav-item { font-size: 1.4rem; color: #B0B3B8; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .post-card { margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .post-header { padding: 10px; display: flex; align-items: center; font-weight: 600; }
        .post-pfp { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
        .post-image { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
        .fab { position: absolute; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 90; cursor: pointer; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; }
        #conversation-screen { position: absolute; inset: 0; background: #E5DDD5; z-index: 500; transform: translateX(100%); transition: 0.3s; display: flex; flex-direction: column; }
        #conversation-screen.active { transform: translateX(0); }
        .messages-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; }
        .msg-sent { align-self: flex-end; background: var(--msg-out); }
        .msg-received { align-self: flex-start; background: var(--msg-in); }
    </style>
</head>
<body>
<div id="app-container">
      <div id="auth-layer" class="auth-screen">
        <h1 class="logo-text">Pollygram</h1>
        <div id="login-form">
            <p id="login-error" style="color:red; font-size:0.8rem;"></p>
            <input type="text" id="login-username" class="auth-input" placeholder="Usuário">
            <input type="password" id="login-password" class="auth-input" placeholder="Senha">
            <button class="auth-btn" onclick="handleLogin()">Entrar</button>
            <p onclick="toggleAuth('signup')" style="margin-top:15px; color:var(--primary); cursor:pointer;">Criar conta</p>
        </div>
        <div id="signup-form" class="hidden">
            <input type="text" id="signup-username" class="auth-input" placeholder="Novo Usuário">
            <input type="password" id="signup-pass" class="auth-input" placeholder="Senha">
            <button class="auth-btn" onclick="handleSignup()">Cadastrar</button>
            <p onclick="toggleAuth('login')" style="margin-top:15px; color:var(--primary); cursor:pointer;">Já tenho conta</p>
        </div>
    </div>

    <div id="main-app" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <header><h1 style="font-size:1.4rem; color:var(--primary);">Pollygram</h1></header>
        <div class="main-content" id="content-area">
            <div id="tab-feed" class="tab-pane"><div id="feed-list"></div><div class="fab" onclick="openModal('post-modal')"><i class="fas fa-plus"></i></div></div>
            <div id="tab-chat" class="tab-pane hidden"><div id="chat-list"></div><div class="fab" onclick="openUserListModal()"><i class="fas fa-comment"></i></div></div>
            <div id="tab-status" class="tab-pane hidden"><div id="status-list"></div></div>
            <div id="tab-profile" class="tab-pane hidden" style="text-align:center; padding:20px;">
                <img id="profile-pic" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid var(--primary);">
                <h2 id="profile-username"></h2>
                <button onclick="handleLogout()" style="color:red; border:none; background:none; cursor:pointer;">Sair</button>
                <div id="profile-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:2px; margin-top:20px;"></div>
            </div>
        </div>
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('feed', this)"><i class="fas fa-home"></i></div>
            <div class="nav-item" onclick="switchTab('chat', this)"><i class="fas fa-paper-plane"></i></div>
            <div class="nav-item" onclick="switchTab('profile', this)"><i class="fas fa-user"></i></div>
        </nav>
    </div>
      <div id="conversation-screen">
        <div style="background:white; padding:10px; display:flex; align-items:center; border-bottom:1px solid #ddd;">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="margin-right:15px; cursor:pointer;"></i>
            <span id="chat-active-name" style="font-weight:bold;"></span>
        </div>
        <div class="messages-area" id="messages-container"></div>
        <div style="padding:10px; background:white; display:flex;">
            <input type="text" id="msg-input" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;" placeholder="Mensagem...">
            <button onclick="sendMessage()" style="background:var(--primary); color:white; border:none; border-radius:50%; width:40px; margin-left:10px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="post-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Novo Post</h3>
            <input type="file" id="post-file" accept="image/*" style="margin-bottom:10px;">
            <input type="text" id="post-caption" class="auth-input" placeholder="Legenda...">
            <button class="auth-btn" onclick="uploadPost()">Postar</button>
            <button onclick="closeModal('post-modal')" style="width:100%; margin-top:10px; border:none; background:none;">Cancelar</button>
        </div>
    </div>

    <div id="user-list-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Iniciar Conversa</h3>
            <div id="all-users-list" style="max-height:300px; overflow-y:auto;"></div>
            <button onclick="closeModal('user-list-modal')" style="width:100%; margin-top:10px; border:none;">Fechar</button>
        </div>
    </div>
</div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyARAb2yqL8YxEkmALKQ6DJckMW9a06cer0",
        authDomain: "pollygram.firebaseapp.com",
        projectId: "pollygram",
        storageBucket: "pollygram.appspot.com", // Ajustado para o padrão do Firebase
        messagingSenderId: "725225787747",
        appId: "1:725225787747:web:4052e92bba8c3447188356"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let activeChatId = null;

    // --- FUNÇÕES DE AUTH ---
    window.toggleAuth = (v) => {
        document.getElementById('login-form').classList.toggle('hidden', v==='signup');
        document.getElementById('signup-form').classList.toggle('hidden', v==='login');
    };

    window.handleLogin = async () => {
        const u = document.getElementById('login-username').value;
        const p = document.getElementById('login-password').value;
        try { await signInWithEmailAndPassword(auth, `${u}@polly.com`, p); } 
        catch (e) { document.getElementById('login-error').innerText = "Erro ao entrar."; }
    };

    window.handleSignup = async () => {
        const u = document.getElementById('signup-username').value;
        const p = document.getElementById('signup-pass').value;
        try {
            const res = await createUserWithEmailAndPassword(auth, `${u}@polly.com`, p);
            await updateProfile(res.user, { displayName: u, photoURL: "https://via.placeholder.com/150" });
            await setDoc(doc(db, "users", res.user.uid), { uid: res.user.uid, username: u, photoURL: "https://via.placeholder.com/150" });
        } catch (e) { alert("Erro no cadastro."); }
    };

    window.handleLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        document.getElementById('auth-layer').classList.toggle('hidden', !!user);
        document.getElementById('main-app').classList.toggle('hidden', !user);
        if(user) loadAppData();
    });

    // --- LOGICA DO APP ---
    window.switchTab = (tab, el) => {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    };

    function loadAppData() {
        document.getElementById('profile-username').innerText = currentUser.displayName;
        document.getElementById('profile-pic').src = currentUser.photoURL;
        
        // Feed
        onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snap) => {
            const list = document.getElementById('feed-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `<div class="post-card">
                    <div class="post-header"><img src="${p.userPhoto}" class="post-pfp">${p.username}</div>
                    <img src="${p.imageUrl}" class="post-image">
                    <div style="padding:10px;"><strong>${p.username}</strong> ${p.caption}</div>
                </div>`;
            });
        });

        // Chats
        onSnapshot(query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid)), (snap) => {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const other = c.names.find(n => n !== currentUser.displayName);
                const div = document.createElement('div');
                div.style = "padding:15px; border-bottom:1px solid #eee; cursor:pointer;";
                div.innerText = other;
                div.onclick = () => openChat(d.id, other);
                list.appendChild(div);
            });
        });
    }

    window.uploadPost = async () => {
        const file = document.getElementById('post-file').files[0];
        const cap = document.getElementById('post-caption').value;
        if(!file) return;
        const sRef = ref(storage, `posts/${Date.now()}`);
        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);
        await addDoc(collection(db, "posts"), {
            uid: currentUser.uid, username: currentUser.displayName,
            userPhoto: currentUser.photoURL, imageUrl: url, caption: cap, timestamp: Date.now()
        });
        closeModal('post-modal');
    };

    window.openUserListModal = async () => {
        const snap = await getDocs(collection(db, "users"));
        const list = document.getElementById('all-users-list');
        list.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            if(u.uid === currentUser.uid) return;
            const div = document.createElement('div');
            div.style = "padding:10px; border-bottom:1px solid #eee; cursor:pointer;";
            div.innerText = u.username;
            div.onclick = () => {
                const id = [currentUser.uid, u.uid].sort().join("_");
                setDoc(doc(db, "chats", id), { participants: [currentUser.uid, u.uid], names: [currentUser.displayName, u.username] }, {merge:true});
                openChat(id, u.username);
                closeModal('user-list-modal');
            };
            list.appendChild(div);
        });
        document.getElementById('user-list-modal').classList.remove('hidden');
    };

    window.openChat = (id, name) => {
        activeChatId = id;
        document.getElementById('chat-active-name').innerText = name;
        document.getElementById('conversation-screen').classList.add('active');
        onSnapshot(query(collection(db, "chats", id, "messages"), orderBy("timestamp", "asc")), (snap) => {
            const cont = document.getElementById('messages-container');
            cont.innerHTML = "";
            snap.forEach(m => {
                const data = m.data();
                const mine = data.sender === currentUser.uid;
                cont.innerHTML += `<div class="msg-bubble ${mine ? 'msg-sent' : 'msg-received'}">${data.text}</div>`;
            });
            cont.scrollTop = cont.scrollHeight;
        });
    };

    window.sendMessage = async () => {
        const text = document.getElementById('msg-input').value;
        if(!text) return;
        await addDoc(collection(db, "chats", activeChatId, "messages"), { text, sender: currentUser.uid, timestamp: Date.now() });
        document.getElementById('msg-input').value = "";
    };

    window.closeChat = () => document.getElementById('conversation-screen').classList.remove('active');
    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
</script>
</body>
</html>

