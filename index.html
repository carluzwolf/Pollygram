<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pollygram Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6;
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --border: #334155;
            --accent: #2563eb;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #000; color: var(--text);
            overflow: hidden; /* Impede o scroll da página inteira */
        }

        /* Container Principal: Simula o limite de um celular */
        #app-container {
            width: 100%; max-width: 450px; height: 100%;
            margin: 0 auto; background: var(--bg);
            display: flex; flex-direction: column;
            position: relative;
        }

        /* --- AUTH SCREEN --- */
        .auth-screen {
            position: absolute; inset: 0; background: var(--bg);
            z-index: 2000; padding: 40px 20px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .logo { font-size: 2.5rem; font-weight: 800; text-align: center; margin-bottom: 40px; color: var(--primary); letter-spacing: -1px; }
        .auth-input { 
            width: 100%; background: var(--surface); border: 1px solid var(--border);
            padding: 16px; border-radius: 12px; color: white; margin-bottom: 12px; font-size: 1rem;
        }
        .btn-prime {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer;
            transition: 0.2s;
        }
        .btn-prime:active { transform: scale(0.98); opacity: 0.9; }

        /* --- HEADER --- */
        header {
            height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border); background: var(--bg);
        }
        header h1 { font-size: 1.2rem; font-weight: 800; margin: 0; color: var(--primary); }

        /* --- ÁREA DE CONTEÚDO (SCROLLABLE) --- */
        .main-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding-bottom: 20px;
        }

        /* --- NAVBAR --- */
        nav {
            height: 70px; display: flex; justify-content: space-around; align-items: center;
            background: var(--surface); border-top: 1px solid var(--border);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { color: var(--text-dim); font-size: 1.4rem; cursor: pointer; transition: 0.3s; position: relative; padding: 10px; }
        .nav-item.active { color: var(--primary); }

        /* --- COMPONENTES --- */
        .post-card { background: var(--surface); margin: 12px; padding: 16px; border-radius: 16px; border: 1px solid var(--border); }
        .user-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .avatar-txt { width: 40px; height: 40px; border-radius: 12px; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; }
        .post-body { line-height: 1.5; font-size: 0.95rem; color: #cbd5e1; }

        .notes-scroll { display: flex; gap: 15px; padding: 15px; overflow-x: auto; scrollbar-width: none; border-bottom: 1px solid var(--border); }
        .notes-scroll::-webkit-scrollbar { display: none; }
        .note-circle { min-width: 65px; text-align: center; }
        .note-bubble { 
            background: var(--surface); border: 1px solid var(--primary); 
            padding: 6px; border-radius: 10px; font-size: 0.7rem; margin-bottom: 6px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .list-item { 
            padding: 16px 20px; display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid var(--border); cursor: pointer;
        }
        .list-item:active { background: var(--surface); }

        /* --- OVERLAYS (Telas que deslizam) --- */
        .overlay {
            position: absolute; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .overlay.active { transform: translateX(0); }
        .overlay-head { height: 60px; padding: 0 20px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); }

        /* --- CHAT --- */
        #chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 0.9rem; line-height: 1.4; }
        .sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: var(--surface); border-bottom-left-radius: 4px; }

        .chat-input-area { padding: 15px; background: var(--surface); display: flex; gap: 10px; }

        /* --- FAB --- */
        .fab {
            position: absolute; bottom: 90px; right: 20px;
            width: 56px; height: 56px; border-radius: 18px;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            cursor: pointer; z-index: 99;
        }

        /* --- MODAL --- */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box { background: var(--surface); width: 100%; max-width: 350px; padding: 24px; border-radius: 20px; border: 1px solid var(--border); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="auth-layer" class="auth-screen">
        <div class="logo">Pollygram</div>
        <div id="login-form">
            <input type="text" id="l-user" class="auth-input" placeholder="Seu Username">
            <input type="password" id="l-pass" class="auth-input" placeholder="Sua Senha">
            <button class="btn-prime" onclick="handleLogin()">Acessar Rede</button>
            <p style="text-align:center; color:var(--text-dim); margin-top:20px;" onclick="toggleAuth('up')">Novo aqui? <span style="color:var(--primary)">Criar conta</span></p>
        </div>
        <div id="signup-form" class="hidden">
            <input type="text" id="s-user" class="auth-input" placeholder="Escolha um Username">
            <input type="password" id="s-pass" class="auth-input" placeholder="Crie uma Senha">
            <button class="btn-prime" onclick="handleSignup()">Finalizar Cadastro</button>
            <p style="text-align:center; color:var(--text-dim); margin-top:20px;" onclick="toggleAuth('in')">Já tem conta? <span style="color:var(--primary)">Login</span></p>
        </div>
    </div>

    <div id="main-app" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <header>
            <h1 id="header-title">Feed</h1>
            <i class="fas fa-search" style="color:var(--text-dim)"></i>
        </header>

        <div class="main-content">
            <div id="tab-feed" class="tab-content">
                <div class="notes-scroll" id="notes-list">
                    <div class="note-circle" onclick="openModal('note-modal')">
                        <div class="note-bubble" style="background:var(--border)">+ Nota</div>
                        <span style="font-size:0.7rem">Você</span>
                    </div>
                </div>
                <div id="feed-items"></div>
                <div class="fab" onclick="openModal('post-modal')"><i class="fas fa-plus"></i></div>
            </div>

            <div id="tab-discover" class="tab-content hidden">
                <div id="users-list"></div>
            </div>

            <div id="tab-chats" class="tab-content hidden">
                <div id="inbox-list"></div>
            </div>

            <div id="tab-me" class="tab-content hidden" style="padding:20px; text-align:center;">
                <div id="my-avatar" class="avatar-txt" style="width:80px; height:80px; font-size:2rem; margin:0 auto 15px;">?</div>
                <h2 id="my-name" style="margin:0;"></h2>
                <p id="my-bio" style="color:var(--text-dim); margin-bottom:20px;">Membro do Pollygram Pro</p>
                <button class="btn-prime" style="background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid #ef4444;" onclick="handleLogout()">Sair</button>
            </div>
        </div>

        <nav>
            <div class="nav-item active" onclick="switchTab('feed', this)"><i class="fas fa-home-alt"></i></div>
            <div class="nav-item" onclick="switchTab('discover', this)"><i class="fas fa-compass"></i></div>
            <div class="nav-item" onclick="switchTab('chats', this)"><i class="fas fa-comment-alt-lines"></i></div>
            <div class="nav-item" onclick="switchTab('me', this)"><i class="fas fa-user"></i></div>
        </nav>
    </div>

    <div id="chat-overlay" class="overlay">
        <div class="overlay-head">
            <i class="fas fa-chevron-left" onclick="closeOverlay('chat-overlay')"></i>
            <span id="chat-user-name" style="font-weight:700;">Chat</span>
        </div>
        <div id="chat-msgs"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-in" class="auth-input" style="margin:0; border-radius:25px;" placeholder="Sua mensagem...">
            <button onclick="sendMsg()" class="btn-prime" style="width:50px; height:50px; border-radius:50%; padding:0;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="post-modal" class="modal hidden">
        <div class="modal-box">
            <h3 style="margin-top:0">Novo Post</h3>
            <textarea id="post-text" class="auth-input" style="height:120px; resize:none;" placeholder="No que está pensando?"></textarea>
            <button class="btn-prime" onclick="savePost()">Publicar</button>
            <button onclick="closeModal('post-modal')" style="width:100%; margin-top:10px; background:none; border:none; color:var(--text-dim);">Cancelar</button>
        </div>
    </div>

    <div id="note-modal" class="modal hidden">
        <div class="modal-box">
            <h3 style="margin-top:0">Nova Nota</h3>
            <input type="text" id="note-text" class="auth-input" maxlength="40" placeholder="Ex: Focado hoje!">
            <button class="btn-prime" onclick="saveNote()">Atualizar</button>
            <button onclick="closeModal('note-modal')" style="width:100%; margin-top:10px; background:none; border:none; color:var(--text-dim);">Fechar</button>
        </div>
    </div>

</div>

<script type="module">
    // --- FIREBASE CONFIG ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyARAb2yqL8YxEkmALKQ6DJckMW9a06cer0",
        authDomain: "pollygram.firebaseapp.com",
        projectId: "pollygram",
        storageBucket: "pollygram.appspot.com",
        messagingSenderId: "725225787747",
        appId: "1:725225787747:web:4052e92bba8c3447188356"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let activeChatId = null;

    // --- AUTH LOGIC ---
    window.toggleAuth = (m) => {
        document.getElementById('login-form').classList.toggle('hidden', m==='up');
        document.getElementById('signup-form').classList.toggle('hidden', m==='in');
    };

    window.handleLogin = async () => {
        const u = document.getElementById('l-user').value;
        const p = document.getElementById('l-pass').value;
        try { await signInWithEmailAndPassword(auth, `${u}@polly.pro`, p); } 
        catch(e) { alert("Erro ao entrar. Verifique os dados."); }
    };

    window.handleSignup = async () => {
        const u = document.getElementById('s-user').value.trim();
        const p = document.getElementById('s-pass').value;
        if(u.length < 3) return alert("Nome muito curto!");
        try {
            const res = await createUserWithEmailAndPassword(auth, `${u}@polly.pro`, p);
            await updateProfile(res.user, { displayName: u });
            await setDoc(doc(db, "users", res.user.uid), { uid: res.user.uid, username: u, bio: "Status: Online", createdAt: Date.now() });
        } catch(e) { alert("Erro: " + e.message); }
    };

    window.handleLogout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        document.getElementById('auth-layer').classList.toggle('hidden', !!user);
        document.getElementById('main-app').classList.toggle('hidden', !user);
        if(user) initApp();
    });

    // --- APP CORE ---
    function initApp() {
        document.getElementById('my-name').innerText = currentUser.displayName;
        document.getElementById('my-avatar').innerText = currentUser.displayName[0].toUpperCase();
        
        loadFeed();
        loadNotes();
        loadUsers();
        loadInbox();
    }

    window.switchTab = (tab, el) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('header-title').innerText = tab.charAt(0).toUpperCase() + tab.slice(1);
    };

    // --- FEED & NOTES ---
    function loadFeed() {
        onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snap) => {
            const list = document.getElementById('feed-items');
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `
                    <div class="post-card">
                        <div class="user-row"><div class="avatar-txt">${p.username[0]}</div><strong>${p.username}</strong></div>
                        <div class="post-body">${p.text}</div>
                    </div>`;
            });
        });
    }

    window.savePost = async () => {
        const t = document.getElementById('post-text').value;
        if(!t) return;
        await addDoc(collection(db, "posts"), { uid: currentUser.uid, username: currentUser.displayName, text: t, timestamp: Date.now() });
        document.getElementById('post-text').value = "";
        closeModal('post-modal');
    };

    function loadNotes() {
        onSnapshot(collection(db, "notes"), (snap) => {
            const list = document.getElementById('notes-list');
            list.innerHTML = `<div class="note-circle" onclick="openModal('note-modal')"><div class="note-bubble" style="background:var(--border)">+ Nota</div><span style="font-size:0.7rem">Você</span></div>`;
            snap.forEach(d => {
                const n = d.data();
                if(n.uid === currentUser.uid) return;
                list.innerHTML += `
                    <div class="note-circle" onclick="openChat('${n.uid}', '${n.username}')">
                        <div class="note-bubble">${n.text}</div>
                        <span style="font-size:0.7rem">${n.username}</span>
                    </div>`;
            });
        });
    }

    window.saveNote = async () => {
        const t = document.getElementById('note-text').value;
        if(!t) return;
        await setDoc(doc(db, "notes", currentUser.uid), { uid: currentUser.uid, username: currentUser.displayName, text: t });
        closeModal('note-modal');
    };

    // --- USERS & MESSAGES ---
    async function loadUsers() {
        const snap = await getDocs(collection(db, "users"));
        const list = document.getElementById('users-list');
        list.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            if(u.uid === currentUser.uid) return;
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `<div class="avatar-txt">${u.username[0]}</div><div><strong>${u.username}</strong><br><small style="color:var(--text-dim)">${u.bio}</small></div>`;
            item.onclick = () => openChat(u.uid, u.username);
            list.appendChild(item);
        });
    }

    window.openChat = (uid, name) => {
        activeChatId = [currentUser.uid, uid].sort().join("_");
        document.getElementById('chat-user-name').innerText = name;
        document.getElementById('chat-overlay').classList.add('active');
        
        onSnapshot(query(collection(db, "chats", activeChatId, "messages"), orderBy("timestamp", "asc")), (snap) => {
            const cont = document.getElementById('chat-msgs');
            cont.innerHTML = "";
            snap.forEach(m => {
                const msg = m.data();
                const mine = msg.sender === currentUser.uid;
                cont.innerHTML += `<div class="msg ${mine ? 'sent' : 'received'}">${msg.text}</div>`;
            });
            cont.scrollTop = cont.scrollHeight;
        });
    };

    window.sendMsg = async () => {
        const t = document.getElementById('chat-in').value;
        if(!t) return;
        document.getElementById('chat-in').value = "";
        await addDoc(collection(db, "chats", activeChatId, "messages"), { sender: currentUser.uid, text: t, timestamp: Date.now() });
        await setDoc(doc(db, "inbox", activeChatId), {
            participants: activeChatId.split("_"),
            last: t,
            names: [currentUser.displayName, document.getElementById('chat-user-name').innerText],
            ts: Date.now()
        });
    };

    function loadInbox() {
        onSnapshot(query(collection(db, "inbox"), where("participants", "array-contains", currentUser.uid), orderBy("ts", "desc")), (snap) => {
            const list = document.getElementById('inbox-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                const other = data.names.find(n => n !== currentUser.displayName);
                const otherUid = data.participants.find(id => id !== currentUser.uid);
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `<div class="avatar-txt" style="background:var(--surface); border:1px solid var(--border);">${other[0]}</div><div><strong>${other}</strong><br><small style="color:var(--primary)">${data.last}</small></div>`;
                item.onclick = () => openChat(otherUid, other);
                list.appendChild(item);
            });
        });
    }

    // --- UI HELPERS ---
    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.closeOverlay = (id) => document.getElementById(id).classList.remove('active');

</script>
</body>
</html>
